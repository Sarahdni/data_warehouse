-- Vue matérialisée pour l'analyse par taille d'entreprise
CREATE MATERIALIZED VIEW MV_ENTERPRISE_SIZE_EVOLUTION AS
SELECT 
    g.CD_REFNIS_REGION,
    g.TX_NAME_FR as NOM_REGION,
    s.TX_SIZE_CLASS_FR as CLASSE_TAILLE,
    d.CD_YEAR,
    SUM(f.MS_ACTIVE_VAT_COUNT) as TOTAL_ENTREPRISES,
    SUM(f.MS_NEW_VAT_COUNT) as NOUVELLES_ENTREPRISES,
    SUM(f.MS_CLOSED_VAT_COUNT) as CESSATIONS,
    SUM(f.MS_NET_VAT_CREATION) as CREATION_NETTE
FROM FACT_NACE_EMPLOYMENT f
JOIN DIM_GEOGRAPHY g ON f.ID_GEOGRAPHY = g.ID_GEOGRAPHY
JOIN DIM_ENTREPRISE_SIZE_EMPLOYEES s ON f.CD_SIZE_CLASS = s.CD_SIZE_CLASS
JOIN DIM_DATE d ON f.ID_DATE = d.ID_DATE
GROUP BY 
    g.CD_REFNIS_REGION,
    g.TX_NAME_FR,
    s.TX_SIZE_CLASS_FR,
    d.CD_YEAR;